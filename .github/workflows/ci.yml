name: CI - FE Build & BE Smoke (smart + npm install)

on:
  push:
    branches: [ demo2-import ]
  pull_request:
    branches: [ main, demo2-import ]

jobs:
  changes:
    name: Detect changed paths
    runs-on: ubuntu-latest
    outputs:
      fe: ${{ steps.filter.outputs.fe }}
      be: ${{ steps.filter.outputs.be }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            fe:
              - 'capstone-frontend/**'
              - '.github/workflows/ci.yml'
            be:
              - 'capstone-backend/**'
              - '.github/workflows/ci.yml'

  frontend:
    name: Frontend Build
    needs: changes
    if: needs.changes.outputs.fe == 'true'
    runs-on: ubuntu-latest
    defaults: { run: { working-directory: capstone-frontend } }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Install deps
        run: npm install
      - name: Lint (non-blocking)
        run: if npm run | grep -q "^  lint"; then npm run lint || true; fi
      - name: Build
        run: npm run build

  backend:
    name: Backend Smoke
    needs: changes
    if: needs.changes.outputs.be == 'true'
    runs-on: ubuntu-latest
    defaults: { run: { working-directory: capstone-backend } }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install "uvicorn[standard]" requests
      - name: Run & probe
        run: |
          uvicorn main:app --host 0.0.0.0 --port 8000 &
          PID=$!
          for i in {1..10}; do
            echo "Probing... ($i)"
            if curl -fsS http://127.0.0.1:8000/healthz || \
               curl -fsS http://127.0.0.1:8000/ || \
               curl -fsS http://127.0.0.1:8000/docs ; then
              echo "Service is up."
              kill $PID
              exit 0
            fi
            sleep 2
          done
          echo "Service did not become healthy in time."
          kill $PID
          exit 1
